<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Binance Signal Group â€” Admin-Only Chat + Members (100 Countries) + Profit Cards (Real Prices)</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://db.onlinewebfonts.com/c/d05c19ccecf7003d248c60ffd6b5e8f7?family=Binance+PLEX" rel="stylesheet"/>

<style>
  :root{
    /* LIGHT THEME */
    --bg:#e7f9ec;
    --panel:#ffffff;
    --panel2:#f4f8fd;
    --text:#0f172a;
    --muted:#6b7280;
    --accent:#2a9df4;
    --border:#e5edf5;
    --chip:#e8f3ff;

    /* Bubbles */
    --bubble:#ffffff;
    --bubble-border:#e6edf5;
    --bubble-shadow:0 6px 18px rgba(17,24,39,0.06);

    /* NEW PROFIT CARD GREEN */
    --greenNew:#39a271;

    /* New profit card bottom line â€” tuned to the uploaded example */
    --nx-line-color:#1f1f1f;     /* core line color (very dark grey) */
    --nx-line-soft:#0000001a;    /* soft fade edges */

    /* Footer PNG micro-adjusts (UPDATED as requested) */
    --footer-nudge-x: -0.4cm; /* move PNG 0.4cm left */
    --footer-nudge-y: -0.1cm; /* move PNG 0.1cm up  */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .wrap{display:grid; grid-template-rows:auto 1fr; height:100vh;}

  /* Header */
  header{position:sticky; top:0; z-index:10; border-bottom:1px solid var(--border); background:var(--panel); padding:8px 12px;}
  .head-inner{max-width:820px; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:10px;}
  .logo{width:30px; height:30px; border-radius:50%; display:grid; place-items:center; font-weight:800; color:#fff; background:#2a9df4; font-size:14px; flex:0 0 30px;}
  .titles{display:flex; flex-direction:column; line-height:1.05; align-items:flex-start}
  .titles h1{margin:0; font-size:15px; font-weight:700}
  .titles .sub{color:#6b7280; font-size:12px; margin-top:2px}

  /* Layout */
  main{display:grid; grid-template-columns:330px 1fr; gap:0; min-height:0;}
  aside{grid-column:1; border-right:1px solid var(--border); background:var(--panel); display:flex; flex-direction:column; min-height:0}
  .chat{grid-column:2; display:flex; flex-direction:column; min-height:0;}
  .chat-head{padding:6px 16px; border-bottom:1px solid var(--border); background:var(--panel2); min-height:1px}
  .chat-scroll{flex:1; overflow:auto; padding:16px; background:
      radial-gradient(1200px 400px at 20% -10%, rgba(42,157,244,0.08), transparent 50%),
      linear-gradient(180deg, #f6fbff, var(--bg)); position:relative;}

  /* Top loader */
  .top-loader{position:sticky; top:0; left:0; right:0; display:flex; align-items:center; justify-content:center; padding:8px 10px; margin:-16px -16px 8px -16px; background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.75)); border-bottom:1px solid var(--border); z-index:3;}
  .top-loader[hidden]{display:none;}
  .spin{width:16px; height:16px; border-radius:50%; border:2px solid #c8ddff; border-top-color:#2563eb; animation:sp 0.8s linear infinite;}
  @keyframes sp{to{transform:rotate(360deg)}}

  /* Bubble */
  .bub{max-width:74%; margin:10px 0; padding:12px 14px; border-radius:16px; line-height:1.4; font-size:14px; border:1px solid var(--bubble-border); background:var(--bubble); box-shadow:var(--bubble-shadow);}
  .bub.admin{margin-left:auto}
  .bub .meta{font-size:11px; color:var(--muted); margin-top:6px; text-align:right}
  .bub.admin:has(.nx-card), .bub.admin:has(.pcard), .bub.admin:has(img.msg-photo){background:transparent; border:none; box-shadow:none; padding:0;}
  .bub.admin:has(.nx-card) .meta, .bub.admin:has(.pcard) .meta, .bub.admin:has(img.msg-photo) .meta{padding-top:6px}

  /* Members */
  .aside-head{padding:12px; border-bottom:1px solid var(--border); display:grid; gap:10px; background:var(--panel)}
  .search{display:flex; gap:8px}
  .search input{flex:1; background:#f3f8ff; border:1px solid var(--border); color:var(--text); border-radius:12px; padding:10px 12px; outline:none;}
  .members{overflow:auto; padding:8px 8px 14px; background:var(--panel)}
  .row{display:grid; grid-template-columns:42px 1fr auto; gap:10px; align-items:center; padding:8px; border-radius:12px; border:1px solid var(--border); background:#ffffff; margin-bottom:8px}
  .av{width:42px; height:42px; border-radius:50%; display:grid; place-items:center; font-weight:800; color:#ffffff; border:1px solid rgba(0,0,0,.06); letter-spacing:.3px; overflow:hidden;}
  .av img{width:100%; height:100%; object-fit:cover; display:block}
  .name{font-weight:600; font-size:13px}
  .status{display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:600; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#f8fbff; color:#1f2937;}
  .dot{width:8px; height:8px; border-radius:999px; display:inline-block}
  .online .dot{background:#10b981} .offline .dot{background:#9ca3af}

  @media (max-width: 980px){
    main{grid-template-columns:1fr}
    aside{order:-1}
  }

  /* ---- OLD Profit Card (kept) ---- */
  .pcard{
    max-width:300px; width:min(90vw,300px);
    background:url('https://iili.io/KKAe9kv.md.gif') center/cover no-repeat;
    color:#fff; border-radius:10px; padding:0.5cm 14px; position:relative; overflow:hidden;
    box-shadow:0 8px 40px rgba(0,0,0,.25);
    font-family:"Binance PLEX","Segoe UI",Arial,sans-serif;
    font-variant-numeric:tabular-nums;
  }
  .pcard .inner{ transform:translateX(0.55cm); }
  .pcard .header{ display:flex; align-items:flex-start; gap:4px; margin-bottom:0.35cm; transform:translateX(-0.5cm); }
  .pcard .binance-logo{ width:11px; height:11px; margin-top:2px; }
  .pcard .text-block{ display:flex; flex-direction:column; margin-top:1px; }
  .pcard .binance-text{ font-weight:800; font-size:.45rem; color:#f0b90b; letter-spacing:.25px; }
  .pcard .futures-text{ font-size:.5rem; color:#fff; font-weight:700; line-height:1; }
  .pcard .trade-info{ margin:4px 0; font-size:.45rem; font-weight:600; display:flex; gap:0.25cm; }
  .pcard .short{ color:#ff4d6b; } .pcard .long{ color:#00c292; }
  .pcard .percentage{ font-size:1.2rem; font-weight:900; margin:5px 0; }
  .pcard .percentage.green{ color:#00c292; font-size:1.35rem; }
  .pcard .percentage.red{ color:#ff4d6b; }
  .pcard .price-section{ margin:5px 0 6px; }
  .pcard .price-line{ display:flex; justify-content:flex-start; gap:5px; margin-bottom:2px; }
  .pcard .price-label{ color:#ccc; font-size:.45rem; width:65px; font-weight:700; }
  .pcard .price-value{ color:#f0b90b; font-weight:800; font-size:.55rem; margin-left:12px; }
  .pcard .referral-section{ display:flex; align-items:center; gap:6px; margin-top:0.25cm; }
  .pcard .qr{ width:24px; height:24px; border-radius:4px; border:1px solid rgba(255,255,255,.18); object-fit:cover; }
  .pcard .ref-text{ font-size:.42rem; color:#ddd; font-weight:600; }
  .pcard .referral-code{ font-weight:800; font-size:.55rem; letter-spacing:.2px; }
  .pcard .app-text{ font-size:.42rem; color:#f0b90b; margin-top:0; font-weight:700; }

  /* ---- NEW Profit Card ---- */
  .nx-card{
    width:320px; border-radius:16px; overflow:hidden;
    background:#111 center/cover no-repeat;
    border:2px solid #2e2e2e; box-shadow:0 8px 24px rgba(0,0,0,.25);
    color:#fff; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    will-change: background-image;
  }
  .nx-header{ padding:16px; display:flex; align-items:center; gap:12px; margin-bottom:calc(16px + 1cm); }
  .nx-av{ width:34px; height:34px; aspect-ratio:1/1; border-radius:50%; overflow:hidden; flex:0 0 34px; box-shadow:0 0 0 2px rgba(255,255,255,.08); display:grid; place-items:center; background:#000; --av-shift: 0.004cm; }
  .nx-av img{ width:100%; height:100%; display:block; object-fit:cover; object-position:center; border-radius:50%; transform: translateY(var(--av-shift)); will-change: transform; }
  .nx-user{ display:flex; flex-direction:column; line-height:1.1; }
  .nx-name{ font-weight:600; font-size:15px; }
  .nx-time{ font-size:11px; opacity:.9; display:block; margin-top:0.08cm; transform: translateY(0.02cm); }
  .nx-body{ padding:0 16px calc(20px + 1cm); }
  .nx-title{ font-size:16px; font-weight:800; text-transform:uppercase; letter-spacing:.2px; }
  .nx-pos{ margin:6px 0 10px; display:inline-flex; align-items:center; gap:10px; font-size:13px; font-weight:600; }
  .nx-pos .nx-short{ color:#ff6b6b; }
  .nx-pos .nx-long{ color:var(--greenNew); }
  .nx-div{ width:1px; height:12px; background:#6a6a6a; display:inline-block; }
  .nx-lev{ color:#8c9692; }
  .nx-pnl{ display:flex; align-items:baseline; gap:8px; margin:6px 0 8px; }
  .nx-usd,.nx-roi{ font-size:32px; font-weight:800; letter-spacing:-.4px; }
  .nx-u,.nx-percent{ font-size:16px; font-weight:700; }
  .posG{ color:var(--greenNew); }
  .posR{ color:#ff6b6b; }

  /* â†“â†“â†“ Entry/Last prices slightly lower */
  .nx-prices{ position:relative; display:flex; justify-content:space-between; gap:16px; font-size:12px; margin-top:6px; }
  .nx-label{ color:#9a9a9a; font-size:11px; }
  .nx-value{ color:#fff; }
  .nx-last{ position:relative; left:-2.6cm; }

  /* Bottom section */
  .nx-foot{ background:#000; }
  .nx-line{
    display:block; width:100%; height:1.5px; margin-top:6px;
    background:
      linear-gradient(180deg,
        var(--nx-line-soft) 0%,
        var(--nx-line-color) 48%,
        var(--nx-line-color) 52%,
        var(--nx-line-soft) 100%);
  }
  .nx-footc{ padding:14px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; }

  /* FOOTER LEFT BLOCK */
  .nx-id{
    display:grid;
    grid-template-columns: 12px 1fr;   /* col 2 = text/image start */
    grid-template-rows: auto auto;
    column-gap:8px; row-gap:4px;
    align-items:start;
    margin-left:-6px;
    position:relative;
  }
  .nx-footer-img{
    grid-column: 2/3; grid-row: 1/2;
    width:100px;          /* slightly smaller */
    height:auto;
    transform: translate(var(--footer-nudge-x), var(--footer-nudge-y));
    display:block;
    filter: drop-shadow(0 0 0 rgba(0,0,0,0));
  }
  .nx-ref{
    grid-column: 2/3; grid-row: 2/3;
    font-size:11px; line-height:1.1; color:#ffffff; letter-spacing:.1px;

    /* Referral code +0.1cm to right */
    display:inline-block;
    transform: translateX(0.1cm);
  }

  /* QR */
  .nx-qr{
    width:54px; height:54px; background:#fff; border-radius:6px; overflow:hidden; display:block; box-shadow:inset 0 0 0 1px #e5e5e5;

    /* UPDATED: move 0.1cm to the LEFT (no vertical shift) */
    transform: translate(-0.1cm, 0);
  }
  .nx-qr img{ width:100%; height:100%; object-fit:contain; }

  /* Composer */
  .composer{ position:sticky; bottom:0; left:0; right:0; background:var(--panel); border-top:1px solid var(--border); padding:8px 12px; display:flex; align-items:center; gap:8px; z-index:5; }
  .c-emoji{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--border);background:#fff;cursor:pointer}
  .composer .box{ flex:1; display:flex; align-items:center; gap:8px; background:#f7fbff; border:1px solid var(--border); border-radius:999px; padding:8px 12px; }
  .composer input[type="text"]{ flex:1; border:none; background:transparent; outline:none; font-size:14px; color:var(--text); }
  .c-icon{width:22px;height:22px; display:grid; place-items:center; cursor:pointer; opacity:.8}
  .send{ width:40px;height:40px;border-radius:999px;background:#1da1ff;border:none;color:#fff;font-weight:700;cursor:pointer; display:grid;place-items:center; }
  .send:active{transform:translateY(1px)}

  /* Manual photo size = profit card width */
  img.msg-photo{max-width:min(85vw,520px); height:auto; border-radius:14px; display:block}
  .preview-note{font-size:12px; color:#2563eb; margin-left:6px}
</style>

<!-- Keep manual-upload photos same width as 320px profit card -->
<style>
  .bub.admin:has(img.msg-photo){ max-width: 320px; padding: 0; border: none; background: transparent; box-shadow: none; }
  img.msg-photo{ width: 320px; max-width: 320px; height: auto; display: block; border-radius: 16px; }
  @media (max-width: 380px){
    .bub.admin:has(img.msg-photo){ max-width: 90vw; }
    img.msg-photo{ width: 90vw; max-width: 90vw; }
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- Centered Header -->
  <header>
    <div class="head-inner" aria-live="polite">
      <div class="logo">KH</div>
      <div class="titles">
        <h1>kin hunther</h1>
        <div class="sub" id="khMembers">â€” members</div>
      </div>
    </div>
  </header>

  <main>
    <!-- Members (LEFT) -->
    <aside>
      <div class="aside-head">
        <div class="search">
          <input id="search" placeholder="Search membersâ€¦"/>
        </div>
      </div>
      <div class="members" id="members"></div>
    </aside>

    <!-- Chat Area -->
    <section class="chat">
      <div class="chat-head"></div>

      <div class="chat-scroll" id="chatScroll">
        <!-- TOP sticky loader (spinner ONLY) -->
        <div id="topLoader" class="top-loader" role="status" aria-live="polite" hidden>
          <span class="spin" aria-hidden="true"></span>
        </div>
      </div>

      <!-- Bottom Message Composer -->
      <div class="composer">
        <div class="c-emoji" title="Emoji">ðŸ˜Š</div>
        <div class="box">
          <input id="msgInput" type="text" placeholder="Message"/>
          <span class="c-icon" title="Attach">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 1 1-8.49-8.49l10.6-10.6a4 4 0 0 1 5.66 5.66L9.88 17.95a2 2 0 1 1-2.83-2.83l9.19-9.19"/></svg>
          </span>
          <span class="c-icon" id="imgBtn" title="Photo">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
          </span>
          <input id="imgInput" type="file" accept="image/*" hidden>
          <span id="imgPreviewNote" class="preview-note" hidden>Photo ready to send</span>
        </div>
        <button class="send" id="sendBtn" aria-label="Send">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
    </section>
  </main>
</div>

<script>
/* ====================== UTILS ====================== */
function numberWithCommas(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function pad2(n){return n.toString().padStart(2,'0')}
function randomTimeHHMMSS(){ return pad2(Math.floor(Math.random()*24))+':'+pad2(Math.floor(Math.random()*60))+':'+pad2(Math.floor(Math.random()*60)); }
function initialsFromName(full){ const parts = full.trim().split(/\s+/); const f = parts[0]?.[0] || ''; const l = parts[1]?.[0] || ''; return (f + l).toUpperCase(); }

/* ====================== MEMBERS + HEADER COUNT ====================== */
const members = [];
const seedCount = 1200;
const firsts = ['Mia','Amelia','Arman','Valentina','Luna','Seung','Kenji','Alex','Yuki','Ishan','Sara','Leo','Noah','Ava','Ethan','Layla','Nina','Ivan','Luis','Aria','Kai','Hana','Zara','Milan','Nora'];
const lasts  = ['Perera','Garcia','Torraux','Silva','Khan','Kumar','Gomez','Ivanov','Lee','Nguyen','Hassan','Yilmaz','Costa','Santos','Hansen','Novak','Almeida','Park','Sato','Smith'];
for (let i=0;i<seedCount;i++){
  const name = `${pick(firsts)} ${pick(lasts)}`; const status = Math.random()<0.55 ? 'online' : 'offline';
  members.push({id:i+1, name, status});
}
const min = 320000, max = 340000;
const total = Math.floor(Math.random()*(max-min+1))+min;
document.getElementById('khMembers').textContent = numberWithCommas(total) + ' members';

const membersEl = document.getElementById('members');
const searchEl  = document.getElementById('search');
let viewSlice = 120; const PAGE=60;

/* AVATARS */
const AVATAR_URLS_RAW = [
  "https://iili.io/KgWxHu9.jpg","https://iili.io/KgWnO0l.jpg","https://iili.io/KgWCeAF.jpg","https://iili.io/KgWCJja.jpg",
  "https://iili.io/KgWBzqQ.jpg","https://iili.io/KgWqTRn.jpg","https://iili.io/KgWfa8F.jpg","https://iili.io/KgWK4pa.jpg",
  "https://iili.io/KgWKzqN.jpg","https://iili.io/KgWF8Rs.jpg","https://iili.io/KgW3vZQ.jpg","https://iili.io/KgW3K41.jpg",
  "https://iili.io/KgW2rkG.jpg","https://iili.io/KgW27mx.jpg","https://iili.io/KgWdDOv.jpg","https://iili.io/KgWdhVS.jpg",
  "https://iili.io/KgWdocg.jpg","https://iili.io/KgWJs9f.jpg","https://iili.io/KgVY3XI.th.jpg","https://iili.io/KgV7LzB.th.jpg",
  "https://iili.io/KgV7WUG.th.jpg","https://iili.io/KgV7Ala.th.jpg","https://iili.io/KgV5sPn.th.jpg","https://iili.io/KgV594a.th"
];
const AVATAR_URLS = shuffle([...new Set(AVATAR_URLS_RAW)]);
const first100Ids = shuffle(members.slice(0,100).map(m=>m.id));
const avatarMap = new Map();
const assignCount = Math.min(first100Ids.length, AVATAR_URLS.length);
for (let i=0;i<assignCount;i++){ avatarMap.set(first100Ids[i], AVATAR_URLS[i]); }
function randomAvatarColor(){
  const hues = [205,150,45,265,10,185,95,320,25,140];
  const h = pick(hues), s = 75 + Math.floor(Math.random()*15), l = 52 + Math.floor(Math.random()*6);
  return `hsl(${h} ${s}% ${l}%)`;
}
function renderMembers(){
  const q = searchEl.value.toLowerCase().trim();
  const filtered = members.filter(m => q ? m.name.toLowerCase().includes(q) : true);
  const toShow = filtered.slice(0, viewSlice);
  membersEl.innerHTML='';
  toShow.forEach(m=>{
    const row = document.createElement('div'); row.className='row';
    const badgeCls = m.status === 'online' ? 'online' : 'offline';
    const avUrl = avatarMap.get(m.id);
    const color = randomAvatarColor();
    const init = (m.name.split(/\s+/).map(x=>x[0]).join('').slice(0,2) || 'U').toUpperCase();
    const avHTML = avUrl
      ? `<div class="av" aria-hidden="true"><img src="${avUrl}" alt="${m.name} profile"></div>`
      : `<div class="av" aria-hidden="true" style="background:${color}">${init}</div>`;
    row.innerHTML = `${avHTML}<div><div class="name">${m.name}</div></div><div class="status ${badgeCls}"><span class="dot"></span>${m.status === 'online' ? 'Online' : 'Offline'}</div>`;
    membersEl.appendChild(row);
  });
}
searchEl.addEventListener('input', ()=>{ viewSlice = 120; renderMembers(); });
membersEl.addEventListener('scroll', e=>{ if (membersEl.scrollTop + membersEl.clientHeight >= membersEl.scrollHeight-20){ viewSlice += PAGE; renderMembers(); }});
renderMembers();

/* ============================ CHAT / CARDS ============================ */
const CHAT = document.getElementById('chatScroll');
const TOP_LOADER = document.getElementById('topLoader');
const DOM_CAP = 500;

/* Binance endpoints */
const API = {
  futuresKlines: 'https://fapi.binance.com/fapi/v1/klines',
  ping: 'https://fapi.binance.com/fapi/v1/ping'
};
const SYMBOLS = [
  'BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','DOGEUSDT','ADAUSDT',
  'TONUSDT','AVAXUSDT','LINKUSDT','NEARUSDT','MATICUSDT','OPUSDT','ARBUSDT','ATOMUSDT'
];

/* ====== Date ranges per your request ======
   TODAY (Asia/Colombo date requested): 2025-10-25
   NEW   : 2025-10-25 â†’ 2025-07-02 (inclusive, newest -> oldest)
   OLD   : 2025-07-03  â†’ 2023-03-02 (inclusive, newest -> oldest)
*/
const NEW_START = new Date('2025-10-25T00:00:00Z');
const NEW_END   = new Date('2025-07-02T00:00:00Z');
const OLD_START = new Date('2025-07-03T00:00:00Z');
const OLD_END   = new Date('2023-03-02T00:00:00Z');

function buildDaysDescending(startDate, endDate){
  const days=[]; for(let t=startDate.getTime(); t>=endDate.getTime(); t-=86400000){ days.push(new Date(t)); } return days;
}
const NEW_DAYS = buildDaysDescending(NEW_START, NEW_END);
const OLD_DAYS = buildDaysDescending(OLD_START, OLD_END);
/* Combined order: show NEW range first (new profit cards), then older */
const DAYS = [...NEW_DAYS, ...OLD_DAYS];

function isInNewRange(d){
  const t = d.getTime();
  return t <= NEW_START.getTime() && t >= NEW_END.getTime();
}

/* helpers */
function dateYMD(d){ return new Date(d).toISOString().slice(0,10); }

/* number formatting: ensure â‰¥ 3 decimals for prices */
function fmtPrice(n){
  return Number(n).toLocaleString(undefined,{minimumFractionDigits:3, maximumFractionDigits:6});
}
function fmt2(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

/* cache */
const klinesCache = new Map();
async function loadDailyKlines(symbol, day){
  const dayStart = new Date(Date.UTC(day.getUTCFullYear(), day.getUTCMonth(), day.getUTCDate(), 0,0,0,0));
  const dayEnd   = new Date(dayStart.getTime() + 86400000 - 1);
  const key = `${symbol}:${dayStart.toISOString().slice(0,10)}`;
  if (klinesCache.has(key)) return klinesCache.get(key);

  const params = new URLSearchParams({
    symbol, interval:'1d',
    startTime: dayStart.getTime(),
    endTime: dayEnd.getTime()
  });
  const res = await fetch(`${API.futuresKlines}?${params.toString()}`, {cache:'no-store'});
  if(!res.ok) { klinesCache.set(key, null); return null; }
  const data = await res.json();
  const row = Array.isArray(data) && data.length ? data[0] : null;
  if(!row){ klinesCache.set(key, null); return null; }
  const out = { openTime: row[0], open: parseFloat(row[1]), close: parseFloat(row[4]) };
  klinesCache.set(key, out);
  return out;
}

/* ======= NEW card background GIFs ======= */
const NX_BACKGROUNDS = ['https://iili.io/Kgp9GJj.gif','https://iili.io/Kr9UiVR.gif'];
NX_BACKGROUNDS.forEach(src=>{ const img=new Image(); img.src=src; });

/* ---- Card builders ---- */
function makeProfitCardOld({side, leverage, symbol, entry, last, roiPct, ref}){
  const wrap = document.createElement('div');
  wrap.className = 'pcard';
  wrap.innerHTML = `
    <div class="inner">
      <div class="header">
        <img class="binance-logo" src="https://iili.io/KKRCyss.th.png" alt="Binance Logo" />
        <div class="text-block">
          <div class="binance-text">BINANCE</div>
          <div class="futures-text">FUTURES</div>
        </div>
      </div>
      <div class="trade-info">
        <span class="${side==='LONG'?'long':'short'}">${side==='LONG'?'Long':'Short'}</span>
        <span>|</span><span>${leverage}x</span>
        <span>|</span><span>${symbol} Perpetual</span>
      </div>
      <div class="percentage ${roiPct>=0?'green':'red'}">${roiPct>=0?'+':''}${roiPct.toFixed(2)}%</div>
      <div class="price-section">
        <div class="price-line"><span class="price-label">Entry Price</span><span class="price-value">${fmtPrice(entry)}</span></div>
        <div class="price-line"><span class="price-label">Last Price</span><span class="price-value">${fmtPrice(last)}</span></div>
      </div>
      <div class="referral-section">
        <img class="qr" src="https://iili.io/K1dUMml.jpg" alt="QR Code"/>
        <div>
          <div class="ref-text">Referral Code</div>
          <div class="referral-code">${ref}</div>
          <div class="app-text">Get the Binance App</div>
        </div>
      </div>
    </div>`;
  return wrap;
}

function makeProfitCardNew({side, leverage, symbol, entry, last, roiPct, pnlUSDT, member, ymd, randomTime, ref}){
  const wrap = document.createElement('div');
  wrap.className = 'nx-card';
  wrap.style.background = `#111 url("${pick(NX_BACKGROUNDS)}") center/cover no-repeat`;
  const positive = roiPct >= 0;
  const showROI = Math.random()<0.6;
  const pnlLine = showROI
    ? `<div class="nx-roi ${positive?'posG':'posR'}">${positive?'+':''}${roiPct.toFixed(2)}%</div><div class="nx-percent"></div>`
    : `<div class="nx-usd ${positive?'posG':'posR'}">${positive?'+':''}${fmt2(pnlUSDT)}</div><div class="nx-u">USDT</div>`;

  wrap.innerHTML = `
    <div class="nx-header">
      <div class="nx-av"><img src="https://iili.io/K10FPQ1.th.jpg" alt="${member.name}"></div>
      <div class="nx-user">
        <span class="nx-name">${member.name}</span>
        <span class="nx-time">${ymd} ${randomTime}</span>
      </div>
    </div>
    <div class="nx-body">
      <div class="nx-title">${symbol} PERPETUAL</div>
      <div class="nx-pos">
        <span class="${side==='LONG'?'nx-long':'nx-short'}">${side==='LONG'?'Long':'Short'}</span>
        <span class="nx-div"></span>
        <span class="nx-lev">${leverage}x</span>
      </div>
      <div class="nx-pnl">${pnlLine}</div>
      <div class="nx-prices">
        <div class="nx-entry"><div class="nx-label">Entry Price</div><div class="nx-value">${fmtPrice(entry)}</div></div>
        <div class="nx-last"><div class="nx-label">Last Price</div><div class="nx-value">${fmtPrice(last)}</div></div>
      </div>
    </div>
    <div class="nx-foot">
      <span class="nx-line"></span>
      <div class="nx-footc">
        <div class="nx-id">
          <!-- Footer PNG (with offsets & size) -->
          <img class="nx-footer-img" src="https://iili.io/KrutTVp.png" alt="Footer image">
          <span class="nx-ref">Referral Code ${ref}</span>
        </div>
        <!-- QR -->
        <span class="nx-qr"><img src="https://iili.io/KrdUz7I.jpg" alt="QR"></span>
      </div>
    </div>`;
  return wrap;
}

/* bubble wrapper with meta (only member name shown) */
function makeAdminBubbleNode(innerNode, metaText){
  const b = document.createElement('div'); b.className = 'bub admin';
  b.appendChild(innerNode);
  if (metaText){ const m = document.createElement('div'); m.className='meta'; m.textContent = metaText; b.appendChild(m); }
  return b;
}

/* ===================== Loader / Batching ===================== */
let nextIndexTop = 0;
const INITIAL_DAYS = 12;
const BATCH_DAYS   = 6;
let preloading = false;

function showTopLoader(on){
  TOP_LOADER.hidden = !on;
  TOP_LOADER.setAttribute('aria-busy', on ? 'true' : 'false');
}

/* ====== Per-day fragment: build 10â€“15 cards using Binance real OHLC ====== */
async function buildDayFragment(day){
  const frag = document.createDocumentFragment();

  const cardsToday = 10 + Math.floor(Math.random() * 6); // [10..15]
  const needSymbols = new Set();
  while (needSymbols.size < Math.min(cardsToday, SYMBOLS.length)){
    needSymbols.add(pick(SYMBOLS));
  }
  await Promise.all(Array.from(needSymbols).map(sym => loadDailyKlines(sym, day)));

  for (let c=0; c<cardsToday; c++){
    const symbol = pick(SYMBOLS);
    const k = await loadDailyKlines(symbol, day);
    if(!k) continue;

    const entry = k.open;
    const last  = k.close;

    const longPct  = ((last - entry) / entry) * 100;
    const shortPct = ((entry - last) / entry) * 100;
    let side = longPct >= shortPct ? 'LONG' : 'SHORT';
    let pctBase = side==='LONG' ? longPct : shortPct;

    // leverage pick â€” bounded to sane ranges
    let lev;
    if (pctBase > 0){
      let Lmin = Math.max(1, Math.ceil(200 / pctBase));
      let Lmax = Math.min(125, Math.floor(2500 / pctBase));
      if (Lmin > Lmax){ Lmin = 1; Lmax = 5; }
      lev = Math.floor(Math.random() * (Lmax - Lmin + 1)) + Lmin;
    } else {
      lev = [3,5,10,20,50][Math.floor(Math.random()*5)];
    }

    const roiPct = pctBase * lev;                 // ROI% ~ price move * leverage
    const notional = 100 + Math.random()*900;     // mock position size
    const pnlUSDT = notional * (roiPct/100);      // PnL in USDT

    const member = members[(Math.random()*members.length)|0];
    const ref = String(Math.floor(100000000 + Math.random()*900000000));

    const ymd = dateYMD(day);
    const isNew = isInNewRange(day);
    const timeText = isNew ? randomTimeHHMMSS() : '12:00:00';

    const node = isNew
      ? makeProfitCardNew({side, leverage:lev, symbol, entry, last, roiPct, pnlUSDT, member, ymd, randomTime:timeText, ref})
      : makeProfitCardOld({side, leverage:lev, symbol, entry, last, roiPct, ref});

    const metaOnlyMember = member.name;
    frag.appendChild(makeAdminBubbleNode(node, metaOnlyMember));
  }
  return frag;
}

async function loadOlderDaysBatch(){
  if (preloading) return;
  preloading = true; showTopLoader(true);

  const before = CHAT.scrollHeight;
  const start = nextIndexTop;
  const end = Math.min(nextIndexTop + BATCH_DAYS, DAYS.length);

  for (let i=start; i<end; i++){
    const dayFrag = await buildDayFragment(DAYS[i]);
    const anchor = TOP_LOADER.nextSibling;
    if (anchor){ CHAT.insertBefore(dayFrag, anchor); } else { CHAT.prepend(dayFrag); }
  }

  nextIndexTop = end;

  const after = CHAT.scrollHeight;
  CHAT.scrollTop += (after - before);

  const bub = CHAT.querySelectorAll('.bub');
  const excess = Math.max(0, bub.length - DOM_CAP);
  for(let i=0;i<excess;i++) bub[i].remove();

  showTopLoader(false); preloading = false;
}

/* ======================= Init ======================= */
(async function init(){
  try{ await fetch(API.ping, {cache:'no-store'}); }catch(e){ /* ignore */ }

  for (let i=0; i<INITIAL_DAYS && i<DAYS.length; i++){
    const frag = await buildDayFragment(DAYS[i]);
    CHAT.appendChild(frag);
    nextIndexTop = i+1;
  }
  CHAT.scrollTop = CHAT.scrollHeight;

  CHAT.addEventListener('scroll', async ()=>{
    if (CHAT.scrollTop <= 100){
      await loadOlderDaysBatch();
    }
  });
})();

/* ======================= Composer: text + photo ======================= */
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msgInput');
const imgBtn = document.getElementById('imgBtn');
const imgInput = document.getElementById('imgInput');
const imgPreviewNote = document.getElementById('imgPreviewNote');

let queuedImageDataURL = null;
let queuedImageName = null;

imgBtn.addEventListener('click', ()=> imgInput.click());
imgInput.addEventListener('change', ()=>{
  const file = imgInput.files?.[0];
  if(!file){ queuedImageDataURL = null; queuedImageName = null; imgPreviewNote.hidden = true; return; }
  const reader = new FileReader();
  reader.onload = (e)=>{ queuedImageDataURL = e.target.result; queuedImageName = file.name || 'photo'; imgPreviewNote.hidden = false; };
  reader.readAsDataURL(file);
});

function appendTextMessage(text){
  const b = document.createElement('div'); b.className = 'bub admin'; b.textContent = text;
  const m = document.createElement('div'); m.className='meta'; m.textContent='Admin';
  b.appendChild(m); CHAT.appendChild(b); CHAT.scrollTop = CHAT.scrollHeight;
}
function appendPhotoMessage(dataURL, altText){
  const b = document.createElement('div'); b.className = 'bub admin';
  const img = document.createElement('img'); img.src = dataURL; img.alt = altText || 'photo'; img.className = 'msg-photo';
  b.appendChild(img);
  const m = document.createElement('div'); m.className='meta'; m.textContent='Admin';
  b.appendChild(m); CHAT.appendChild(b); CHAT.scrollTop = CHAT.scrollHeight;
}

sendBtn.addEventListener('click', ()=>{
  if (queuedImageDataURL){
    appendPhotoMessage(queuedImageDataURL, queuedImageName);
    queuedImageDataURL = null; queuedImageName = null; imgInput.value = ''; imgPreviewNote.hidden = true;
    const t = msgInput.value.trim(); if (t){ appendTextMessage(t); msgInput.value=''; }
    return;
  }
  const val = msgInput.value.trim(); if(!val) return; appendTextMessage(val); msgInput.value = '';
});
</script>
</body>
</html>
