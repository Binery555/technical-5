<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Untitled</title>
  

</head>
<body>
<!-- partial:index.partial.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Signal Studio — Binance</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      --bg:#0b0f14; --panel:#101722; --panel2:#0c121b; --panel3:#0a111a;
      --text:#e8eef7; --muted:#9ab0c9; --accent:#3ea6ff; --good:#20d17d; --bad:#ff5b6b;
      --ring:#2b82d6; --warn:#ffcf5a; --grid:rgba(255,255,255,.06);
      --card:#111827; --border:#1f2937; --shadow:0 20px 60px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:"Inter",system-ui,ui-sans-serif; background:linear-gradient(180deg,#0b0f14,#0b0f14 40%,#091017); color:var(--text)}
    h1,h2,h3{margin:0}
    header{
      position:sticky; top:0; z-index:20; backdrop-filter:saturate(140%) blur(6px);
      background:linear-gradient(180deg,rgba(11,15,20,.9),rgba(11,15,20,.65));
      border-bottom:1px solid var(--border);
    }
    .bar{max-width:1300px; margin:0 auto; padding:14px 18px; display:grid; gap:12px; grid-template-columns: 220px 1fr auto auto auto; align-items:center}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px}
    .logo{width:28px; height:28px; border-radius:8px; display:grid; place-items:center; background:radial-gradient(120% 120% at 30% 20%, #1a8cff, #6bffc4)}
    .badge{font-size:11px; color:var(--muted)}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label span{font-size:12px; color:var(--muted); margin-right:6px}
    select, input[type="number"], input[type="text"]{
      background:var(--panel2); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; min-width:90px
    }
    select:focus, input:focus{box-shadow:0 0 0 2px var(--ring)}
    button{
      background:linear-gradient(180deg,#1b2737,#141d2b); color:var(--text); border:1px solid var(--border);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:transform .06s ease, box-shadow .12s ease;
    }
    button:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.25)}
    button.primary{background:linear-gradient(180deg,#1b4b85,#15335d); border-color:#1a3a64}
    button.warn{background:linear-gradient(180deg,#5a3a07,#2a1c04); border-color:#443006}
    .pill{display:flex; gap:8px; align-items:center; background:var(--panel2); border:1px solid var(--border); padding:8px 10px; border-radius:999px}

    main{max-width:1300px; margin:18px auto; padding:0 18px; display:grid; grid-template-columns: 1fr 360px; gap:16px}

    /* GRID */
    .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:14px}
    @media (max-width:1200px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:900px){ main{grid-template-columns:1fr} .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){ .grid{grid-template-columns:1fr} }

    .card{
      position:relative; background:linear-gradient(180deg,var(--card),#0c1220);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; overflow:hidden; min-height:148px; display:flex; flex-direction:column; gap:8px
    }
    .card .hdr{display:flex; align-items:center; justify-content:space-between}
    .sym{font-weight:800; letter-spacing:.3px}
    .px{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight:700}
    .muted{color:var(--muted); font-size:12px}

    .sig-badge{display:inline-flex; gap:6px; align-items:center; font-size:12px; padding:6px 8px; border-radius:8px; border:1px dashed var(--border)}
    .sig-badge.good{background:rgba(32,209,125,.08); color:var(--good); border-color:rgba(32,209,125,.35)}
    .sig-badge.bad{background:rgba(255,91,107,.08); color:var(--bad); border-color:rgba(255,91,107,.35)}
    .sig-badge.neutral{background:rgba(255,255,255,.03); color:var(--muted)}

    .signal-hot{outline:2px solid var(--bad); box-shadow:0 0 0 4px rgba(255,91,107,.22) inset, 0 0 0 2px rgba(255,91,107,.35)}
    .flash{animation:flash 0.9s ease 1}
    @keyframes flash{ 0%{background:#2a0f15} 100%{background:transparent} }

    .btn-row{display:flex; gap:8px; flex-wrap:wrap; margin-top:auto}
    .btn-row button{font-size:12px; padding:8px 10px}

    /* DETAILS */
    .panel{position:sticky; top:76px; align-self:start; background:linear-gradient(180deg,var(--panel),var(--panel3)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .panel h3{font-size:16px; margin-bottom:6px}
    .kv{display:grid; grid-template-columns:120px 1fr; gap:8px; margin:6px 0}
    .divider{height:1px; background:linear-gradient(90deg,transparent,var(--border),transparent); margin:10px 0}

    .reel{margin-top:12px; background:var(--panel2); border:1px dashed var(--border); border-radius:12px; padding:10px}
    .reel small{color:var(--muted)}

    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .search{width:100%}

    /* shareable block inside each card */
    .shareable{position:absolute; inset:10px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.06); pointer-events:none}
    .shareable h4{margin:0 0 6px 0}
    .shareable .rows{display:grid; grid-template-columns:110px 1fr; gap:6px}
    .t-xs{font-size:12px}

    .hint{font-size:12px; color:var(--muted)}
    .small{font-size:11px}

    .tag{display:inline-flex; gap:6px; align-items:center; border:1px solid var(--border); background:rgba(255,255,255,.03); padding:6px 8px; border-radius:999px; font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3l7 4v10l-7 4-7-4V7l7-4z" stroke="#0b0f14" stroke-width="1.2"/><path d="M12 3l7 4-7 4-7-4 7-4zm0 8l7-4v10l-7 4v-10z" fill="#fff" fill-opacity=".85"/></svg></div>
        <div>
          AI Signal Studio <span class="badge">Binance multi-coin scanner</span>
        </div>
      </div>
      <div class="toolbar">
        <label class="pill"><span>Interval</span>
          <select id="interval">
            <option value="1m">1m</option>
            <option value="5m" selected>5m</option>
            <option value="15m">15m</option>
            <option value="1h">1h</option>
          </select>
        </label>
        <label class="pill"><span>Symbols</span>
          <select id="symbolPreset">
            <option value="TOP20">Top 20 USDT</option>
            <option value="TOP50" selected>Top 50 USDT</option>
            <option value="ALL100">100+ USDT (heavy)</option>
          </select>
        </label>
        <label class="pill"><span>Auto-scan</span>
          <select id="autoScan">
            <option value="off">Off</option>
            <option value="30">Every 30s</option>
            <option value="60" selected>Every 60s</option>
            <option value="120">Every 2m</option>
          </select>
        </label>
      </div>
      <div class="controls">
        <input id="search" class="search" type="text" placeholder="Search symbol e.g. BTCUSDT" />
      </div>
      <div class="controls">
        <button id="btnScan" class="primary">Start Scan</button>
        <button id="btnStop">Stop</button>
      </div>
      <div class="controls">
        <button id="btnStartReel" class="warn">Start Reel</button>
        <button id="btnStopReel">Stop Reel</button>
      </div>
    </div>
  </header>

  <main>
    <section>
      <div id="grid" class="grid"></div>
    </section>

    <aside class="panel">
      <h3 id="d-sym">—</h3>
      <div class="kv small"><div class="muted">Timeframe</div><div id="d-tf">—</div></div>
      <div class="kv"><div class="muted">Entry</div><div id="d-entry">—</div></div>
      <div class="kv"><div class="muted">Stop Loss</div><div id="d-sl">—</div></div>
      <div class="kv"><div class="muted">Take Profit</div><div id="d-tp">—</div></div>
      <div class="kv"><div class="muted">Leverage</div><div id="d-lev">—</div></div>
      <div class="kv"><div class="muted">Direction</div><div id="d-dir">—</div></div>
      <div class="kv"><div class="muted">Confidence</div><div id="d-conf">—</div></div>
      <div class="divider"></div>
      <div class="kv"><div class="muted">RSI(14)</div><div id="d-rsi">—</div></div>
      <div class="kv"><div class="muted">MACD</div><div id="d-macd">—</div></div>
      <div class="kv"><div class="muted">ATR(14)</div><div id="d-atr">—</div></div>
      <div class="divider"></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button id="btnShare" disabled>Share → PNG</button>
        <button id="btnCopy" disabled>Copy Conditions</button>
      </div>
      <div class="reel">
        <strong>Signal Reel</strong>
        <div class="hint">Cycles through hot signals. Use Start/Stop Reel, then optional recording in your screen recorder. (Or share PNG from each card.)</div>
      </div>
      <div class="divider"></div>
      <div class="hint">⚠️ Educational demo. Always verify risk parameters and exchange limits before real trading.</div>
    </aside>
  </main>

  <script>
    // ======== CONFIG ========
    const PRESETS = {
      TOP20:["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","AVAXUSDT","TRXUSDT","TONUSDT","PEPEUSDT","DOTUSDT","LINKUSDT","SHIBUSDT","BCHUSDT","MATICUSDT","ICPUSDT","NEARUSDT","APTUSDT","OPUSDT"],
      TOP50:["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","AVAXUSDT","TRXUSDT","TONUSDT","PEPEUSDT","DOTUSDT","LINKUSDT","SHIBUSDT","BCHUSDT","MATICUSDT","ICPUSDT","NEARUSDT","APTUSDT","OPUSDT","ARBUSDT","ATOMUSDT","ETCUSDT","LTCUSDT","FILUSDT","INJUSDT","SUIUSDT","SEIUSDT","UNIUSDT","HBARUSDT","TIAUSDT","FTMUSDT","VETUSDT","RUNEUSDT","RONINUSDT","AAVEUSDT","GALAUSDT","JUPUSDT","SANDUSDT","AXSUSDT","BLURUSDT","ENSUSDT","THETAUSDT","XLMUSDT","ALGOUSDT","PYTHUSDT","WIFUSDT","STXUSDT","BONKUSDT","WLDUSDT"],
      ALL100:[
        // 100+ common USDT pairs (trim/add as needed)
        "BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","AVAXUSDT","TRXUSDT","TONUSDT","PEPEUSDT","DOTUSDT","LINKUSDT","SHIBUSDT","BCHUSDT","MATICUSDT","ICPUSDT","NEARUSDT","APTUSDT","OPUSDT","ARBUSDT","ATOMUSDT","ETCUSDT","LTCUSDT","FILUSDT","INJUSDT","SUIUSDT","SEIUSDT","UNIUSDT","HBARUSDT","TIAUSDT","FTMUSDT","VETUSDT","RUNEUSDT","RONINUSDT","AAVEUSDT","GALAUSDT","JUPUSDT","SANDUSDT","AXSUSDT","BLURUSDT","ENSUSDT","THETAUSDT","XLMUSDT","ALGOUSDT","PYTHUSDT","WIFUSDT","STXUSDT","BONKUSDT","WLDUSDT",
        "ORDIUSDT","STRKUSDT","FLOWUSDT","ARUSDT","IMXUSDT","TIAUSDT","OPULUSDT","COMPUSDT","KASUSDT","AGIXUSDT","FETUSDT","IOUSDT","SKLUSDT","SXPUSDT","CFXUSDT","CHZUSDT","DYDXUSDT","APEUSDT","MINAUSDT","LDOUSDT","RDNTUSDT","GMXUSDT","MANAUSDT","RNDRUSDT","BLZUSDT","BANDUSDT","1INCHUSDT","ALICEUSDT","OCEANUSDT","CRVUSDT","ZRXUSDT","KAVAUSDT","SNXUSDT","FLUXUSDT","ROSEUSDT","ZENUSDT","NKNUSDT","DASHUSDT","QTUMUSDT","ANKRUSDT","ZILUSDT","WOOUSDT","BELUSDT","YFIUSDT","RENUSDT","GALUSDT","HOOKUSDT","SSVUSDT","IDUSDT","ARKMUSDT","CYBERUSDT","TIAUSDT"
      ]
    };

    const state = {
      symbols:[...PRESETS.TOP50],
      interval:'5m',
      scanning:false,
      timer:null,
      lastSignals:{}, // symbol -> timestamp of last hot trigger
      selectedSymbol:null,
      reelTimer:null,
    };

    // ======== UI DOM ========
    const $grid = document.getElementById('grid');
    const $search = document.getElementById('search');
    const $interval = document.getElementById('interval');
    const $preset = document.getElementById('symbolPreset');
    const $autoScan = document.getElementById('autoScan');
    const $btnScan = document.getElementById('btnScan');
    const $btnStop = document.getElementById('btnStop');
    const $btnShare = document.getElementById('btnShare');
    const $btnCopy = document.getElementById('btnCopy');
    const $btnStartReel = document.getElementById('btnStartReel');
    const $btnStopReel = document.getElementById('btnStopReel');

    const D = (id)=>document.getElementById(id);

    // detail ids
    const d_ids = ['d-sym','d-tf','d-entry','d-sl','d-tp','d-lev','d-dir','d-conf','d-rsi','d-macd','d-atr'];

    // ======== HELPERS ========
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

    function fmt(n, p=4){ if(n==null||Number.isNaN(n)) return '—'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:p, minimumFractionDigits: (n<1?Math.min(p,6):2)}) }
    function pct(n){return (n*100).toFixed(1)+'%'}

    function playBeep(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type='sine'; o.frequency.setValueAtTime(880, ctx.currentTime);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.20);
        o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.22);
      }catch(e){/* ignore */}
    }

    function createCard(symbol){
      const el = document.createElement('div');
      el.className = 'card'; el.id = `card-${symbol}`; el.dataset.symbol = symbol;
      el.innerHTML = `
        <div class="hdr">
          <div>
            <div class="sym">${symbol}</div>
            <div class="muted small" id="${symbol}-status">Waiting scan…</div>
          </div>
          <div class="px" id="${symbol}-price">—</div>
        </div>
        <div>
          <span id="${symbol}-badge" class="sig-badge neutral">No signal</span>
        </div>
        <div class="btn-row">
          <button data-act="details">Details</button>
          <button data-act="share">Share</button>
        </div>
        <div class="shareable" id="share-${symbol}" aria-hidden="true">
          <h4>${symbol} — Signal Card</h4>
          <div class="rows t-xs">
            <div>Entry</div><div id="s-${symbol}-entry">—</div>
            <div>Stop Loss</div><div id="s-${symbol}-sl">—</div>
            <div>Take Profit</div><div id="s-${symbol}-tp">—</div>
            <div>Leverage</div><div id="s-${symbol}-lev">—</div>
            <div>Direction</div><div id="s-${symbol}-dir">—</div>
            <div>Timeframe</div><div id="s-${symbol}-tf">—</div>
            <div>Confidence</div><div id="s-${symbol}-conf">—</div>
            <div>Timestamp</div><div id="s-${symbol}-ts">—</div>
          </div>
        </div>
      `;

      el.addEventListener('click', (e)=>{
        const act = e.target?.dataset?.act;
        if(!act) return;
        if(act==='details'){ selectSymbol(symbol); }
        if(act==='share'){ shareCard(symbol); }
      });

      return el;
    }

    function mountGrid(){
      $grid.innerHTML = '';
      state.symbols.forEach(sym=> $grid.appendChild(createCard(sym)) );
    }

    // ======== DATA: Binance Klines ========
    async function getKlines(symbol, interval, limit=210){
      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error('HTTP '+r.status);
      const raw = await r.json();
      // kline: [openTime, open, high, low, close, volume, closeTime, ...]
      return raw.map(k=>({
        t:k[0], o:parseFloat(k[1]), h:parseFloat(k[2]), l:parseFloat(k[3]), c:parseFloat(k[4]), v:parseFloat(k[5])
      }));
    }

    // ======== INDICATORS ========
    function SMA(series, period){
      const out = new Array(series.length).fill(null);
      let sum = 0; for(let i=0;i<series.length;i++){
        sum += series[i];
        if(i>=period) sum -= series[i-period];
        if(i>=period-1) out[i] = sum/period;
      }
      return out;
    }
    function EMA(series, period){
      const out = new Array(series.length).fill(null);
      const k = 2/(period+1);
      let ema = series[0]; out[0] = ema;
      for(let i=1;i<series.length;i++){ ema = series[i]*k + ema*(1-k); out[i]=ema }
      return out;
    }
    function RSI(closes, period=14){
      const out = new Array(closes.length).fill(null);
      let gain=0, loss=0;
      for(let i=1;i<=period;i++){
        const ch = closes[i]-closes[i-1];
        if(ch>=0) gain += ch; else loss -= ch;
      }
      gain/=period; loss/=period; out[period] = 100 - 100/(1 + (gain/(loss||1e-8)));
      const alpha = 1/period; // RMA approximation
      for(let i=period+1;i<closes.length;i++){
        const ch = closes[i]-closes[i-1];
        const g = Math.max(ch,0), l = Math.max(-ch,0);
        gain = (gain*(period-1)+g)/period; loss=(loss*(period-1)+l)/period;
        out[i] = 100 - 100/(1 + (gain/(loss||1e-8)));
      }
      return out;
    }
    function MACD(closes, fast=12, slow=26, signal=9){
      const emaFast = EMA(closes, fast);
      const emaSlow = EMA(closes, slow);
      const macd = closes.map((_,i)=> (emaFast[i]??0) - (emaSlow[i]??0));
      const macdSignal = EMA(macd.map(x=>x??0), signal);
      const hist = macd.map((x,i)=> x - (macdSignal[i]??0));
      return {macd, signal: macdSignal, hist};
    }
    function ATR(klines, period=14){
      const out = new Array(klines.length).fill(null);
      const tr = new Array(klines.length).fill(null);
      for(let i=0;i<klines.length;i++){
        const k = klines[i];
        if(i===0){ tr[i] = k.h - k.l; continue }
        const prevClose = klines[i-1].c;
        const v = Math.max(k.h-k.l, Math.abs(k.h - prevClose), Math.abs(k.l - prevClose));
        tr[i] = v;
      }
      let sum=0; for(let i=0;i<klines.length;i++){
        sum += (tr[i]||0);
        if(i>=period) sum -= (tr[i-period]||0);
        if(i>=period) out[i] = sum/period;
      }
      return out;
    }
    function Bollinger(closes, period=20, mult=2){
      const ma = SMA(closes, period);
      const out = {mid:ma, upper:new Array(closes.length).fill(null), lower:new Array(closes.length).fill(null)};
      for(let i=period-1;i<closes.length;i++){
        const slice = closes.slice(i-period+1, i+1);
        const avg = ma[i];
        const variance = slice.reduce((s,x)=>s+(x-avg)*(x-avg),0)/period;
        const sd = Math.sqrt(variance);
        out.upper[i] = avg + mult*sd;
        out.lower[i] = avg - mult*sd;
      }
      return out;
    }

    // ======== AI-ish SIGNAL ENGINE ========
    function generateSignal(kl){
      // kl: array of candles
      if(!kl || kl.length<60) return {state:'none'};
      const closes = kl.map(k=>k.c);
      const highs = kl.map(k=>k.h);
      const lows  = kl.map(k=>k.l);
      const rsi = RSI(closes,14);
      const {macd, signal} = MACD(closes,12,26,9);
      const atr = ATR(kl,14);
      const bb  = Bollinger(closes,20,2);

      const i = kl.length-1; // last
      const i1 = i-1;

      const crossUp   = macd[i1] < signal[i1] && macd[i] > signal[i];
      const crossDown = macd[i1] > signal[i1] && macd[i] < signal[i];
      const rsiUp     = rsi[i1] < 30 && rsi[i] > 30;
      const rsiDown   = rsi[i1] > 70 && rsi[i] < 70;
      const aboveMid  = closes[i] > (bb.mid[i]||closes[i]);
      const belowMid  = closes[i] < (bb.mid[i]||closes[i]);

      const vol = atr[i] || (closes[i]*0.004);
      const dirLong  = crossUp && rsiUp && aboveMid;
      const dirShort = crossDown && rsiDown && belowMid;

      let dir = null; if(dirLong) dir='LONG'; if(dirShort) dir='SHORT';
      if(!dir){
        // secondary criteria: band bounce
        if(closes[i1] < (bb.lower[i1]||-1) && closes[i] > (bb.lower[i]||-1)) dir='LONG';
        else if(closes[i1] > (bb.upper[i1]||1e9) && closes[i] < (bb.upper[i]||1e9)) dir='SHORT';
      }

      if(!dir) return {state:'neutral', rsi:rsi[i], macd:macd[i]-signal[i], atr:vol};

      const entry = closes[i];
      const SL = dir==='LONG' ? entry - 1.5*vol : entry + 1.5*vol;
      const TP = dir==='LONG' ? entry + 2.8*vol : entry - 2.8*vol;

      const rr = Math.abs((TP-entry)/(entry-SL));
      const confParts = [
        dirLong||dirShort ? 0.5 : 0,
        rr>1.8 ? 0.2 : 0,
        (Math.abs(macd[i]-signal[i])> (Math.abs(macd[i1]-signal[i1])) ) ? 0.15 : 0,
        (dir==='LONG' ? closes[i] > (bb.mid[i]||closes[i]) : closes[i] < (bb.mid[i]||closes[i])) ? 0.15 : 0
      ];
      let confidence = Math.min(0.95, confParts.reduce((a,b)=>a+b,0));

      const lev = suggestLeverage(vol/entry);

      return {
        state:'hot', dir, entry, sl:SL, tp:TP, rsi:rsi[i], macd:(macd[i]-signal[i]), atr:vol, rr, leverage:lev,
        extra:{
          timeframe: state.interval,
          notes: dir==='LONG' ? 'RSI recovery + MACD cross up + above mid band' : 'RSI cooldown + MACD cross down + below mid band',
          confidence
        }
      }
    }

    function suggestLeverage(relATR){
      // Very conservative suggestion by volatility bucket (spot users can ignore)
      // relATR ~ ATR / price
      if(relATR>0.03) return '≤3x';
      if(relATR>0.02) return '≤5x';
      if(relATR>0.015) return '≤8x';
      if(relATR>0.01) return '≤12x';
      return '≤20x';
    }

    // ======== SCAN ENGINE ========
    async function scanAll(){
      state.scanning = true; $btnScan.disabled=true; $btnStop.disabled=false;
      const syms = [...state.symbols];
      const concurrency = 4;
      let idx = 0;
      const runners = new Array(concurrency).fill(0).map(async ()=>{
        while(idx<syms.length){
          const sym = syms[idx++];
          try{
            const kl = await getKlines(sym, state.interval, 210);
            const sig = generateSignal(kl);
            updateCard(sym, kl[kl.length-1].c, sig);
            await sleep(120); // polite pacing
          }catch(err){
            updateCard(sym, null, {state:'error', err: err.message});
          }
        }
      });
      await Promise.all(runners);
      $btnScan.disabled=false; $btnStop.disabled=false; // keep enabled for quick re-scan
    }

    function stopAll(){
      state.scanning=false; if(state.timer){clearInterval(state.timer); state.timer=null}
      $btnScan.disabled=false; $btnStop.disabled=true;
    }

    function scheduleAuto(){
      if(state.timer){clearInterval(state.timer); state.timer=null}
      const val = $autoScan.value;
      if(val==='off') return;
      state.timer = setInterval(()=>{ if(!state.scanning) scanAll(); }, parseInt(val,10)*1000);
    }

    // ======== UI UPDATE ========
    function updateCard(symbol, price, sig){
      D(`${symbol}-price`).textContent = price? fmt(price): '—';
      const status = D(`${symbol}-status`);
      const badge = D(`${symbol}-badge`);
      const card = D(`card-${symbol}`);

      card.classList.remove('signal-hot','flash');

      if(sig.state==='error'){
        status.textContent = 'Error: '+sig.err; badge.className = 'sig-badge neutral'; badge.textContent = 'Error'; return;
      }
      if(sig.state==='none' || sig.state==='neutral'){
        status.textContent = sig.state==='none' ? 'No data' : 'Neutral';
        badge.className = 'sig-badge neutral'; badge.textContent = 'No signal';
      } else if(sig.state==='hot'){
        status.textContent = `${sig.dir} • RR ${sig.rr.toFixed(2)} • ATR ${fmt(sig.atr,6)}`;
        badge.className = 'sig-badge bad';
        badge.textContent = 'WINNING ENTRY';
        // mark red and beep only if new
        const last = state.lastSignals[symbol]||0, now = Date.now();
        if(now-last > 60000){
          card.classList.add('signal-hot','flash'); playBeep();
          state.lastSignals[symbol]=now;
        } else {
          card.classList.add('signal-hot');
        }
        // fill shareable
        D(`s-${symbol}-entry`).textContent = fmt(sig.entry);
        D(`s-${symbol}-sl`).textContent    = fmt(sig.sl);
        D(`s-${symbol}-tp`).textContent    = fmt(sig.tp);
        D(`s-${symbol}-lev`).textContent   = sig.leverage;
        D(`s-${symbol}-dir`).textContent   = sig.dir;
        D(`s-${symbol}-tf`).textContent    = state.interval;
        D(`s-${symbol}-conf`).textContent  = Math.round(sig.extra.confidence*100)+'%';
        D(`s-${symbol}-ts`).textContent    = new Date().toLocaleString();
      }
    }

    function selectSymbol(symbol){
      state.selectedSymbol = symbol;
      const card = D(`card-${symbol}`);
      // Attempt to read latest info from shareable block if present
      D('d-sym').textContent = symbol;
      D('d-tf').textContent  = state.interval;
      D('d-entry').textContent = D(`s-${symbol}-entry`)?.textContent || '—';
      D('d-sl').textContent    = D(`s-${symbol}-sl`)?.textContent || '—';
      D('d-tp').textContent    = D(`s-${symbol}-tp`)?.textContent || '—';
      D('d-lev').textContent   = D(`s-${symbol}-lev`)?.textContent || '—';
      D('d-dir').textContent   = D(`s-${symbol}-dir`)?.textContent || '—';
      D('d-conf').textContent  = D(`s-${symbol}-conf`)?.textContent || '—';
      // indicators (best-effort from status attrs, not stored; leave as — unless we just scanned)
      $btnShare.disabled=false; $btnCopy.disabled=false;
      card.scrollIntoView({behavior:'smooth', block:'center'});
    }

    async function shareCard(symbol){
      const node = D(`card-${symbol}`);
      // temporarily show the shareable overlay clearly
      const share = D(`share-${symbol}`);
      const prev = share.style.display;
      share.style.display='block'; share.style.background='linear-gradient(180deg,#0e1827,#0b1220)';
      await sleep(10);
      const canvas = await html2canvas(node, {backgroundColor:null, scale:2});
      share.style.display=prev||'';
      const link = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:.]/g,'');
      link.download = `${symbol}_signal_${ts}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function copyConditions(){
      const s = state.selectedSymbol; if(!s) return;
      const txt = [
        `${s} — ${state.interval} WINNING ENTRY`,
        `Entry: ${D(`s-${s}-entry`).textContent}`,
        `Stop Loss: ${D(`s-${s}-sl`).textContent}`,
        `Take Profit: ${D(`s-${s}-tp`).textContent}`,
        `Leverage: ${D(`s-${s}-lev`).textContent}`,
        `Direction: ${D(`s-${s}-dir`).textContent}`,
        `Confidence: ${D(`s-${s}-conf`).textContent}`,
        `Timestamp: ${D(`s-${s}-ts`).textContent}`
      ].join('\n');
      navigator.clipboard?.writeText(txt);
      $btnCopy.textContent = 'Copied!'; setTimeout(()=> $btnCopy.textContent='Copy Conditions', 1200);
    }

    // ======== REEL (auto focus hot cards) ========
    function startReel(){
      stopReel();
      const cards = [...document.querySelectorAll('.card.signal-hot')];
      if(cards.length===0){ alert('No hot signals right now. Run a scan.'); return }
      let i=0;
      state.reelTimer = setInterval(()=>{
        if(cards.length===0) return;
        const c = cards[i % cards.length]; i++;
        c.classList.add('flash'); c.scrollIntoView({behavior:'smooth', block:'center'});
        setTimeout(()=>c.classList.remove('flash'), 900);
      }, 1400);
    }
    function stopReel(){ if(state.reelTimer){ clearInterval(state.reelTimer); state.reelTimer=null; } }

    // ======== FILTER ========
    function applySearch(){
      const q = $search.value.trim().toUpperCase();
      const cards = [...document.querySelectorAll('.card')];
      cards.forEach(c=>{ c.style.display = (!q || c.dataset.symbol.includes(q)) ? '' : 'none'; });
    }

    // ======== WIRE UI ========
    $btnScan.addEventListener('click', scanAll);
    $btnStop.addEventListener('click', stopAll);
    $btnShare.addEventListener('click', ()=>{ if(state.selectedSymbol) shareCard(state.selectedSymbol); });
    $btnCopy.addEventListener('click', copyConditions);
    $btnStartReel.addEventListener('click', startReel);
    $btnStopReel.addEventListener('click', stopReel);

    $interval.addEventListener('change', ()=>{ state.interval = $interval.value; });
    $preset.addEventListener('change', ()=>{ state.symbols = [...PRESETS[$preset.value]||PRESETS.TOP50]; mountGrid(); });
    $autoScan.addEventListener('change', scheduleAuto);
    $search.addEventListener('input', applySearch);

    // init
    mountGrid(); scheduleAuto();

  </script>
</body>
</html>
<!-- partial -->
  
</body>
</html>
